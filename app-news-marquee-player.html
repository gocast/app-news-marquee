<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<!--
`app-news-marquee`

@demo demo/index.html
-->
<dom-module id="app-news-marquee-player">
  <template>
    <style>
      :host {
        display: block;
      }

      #container {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        height: 100%;
        overflow: hidden;
        width: 100%;
      }

      #headlines {
        white-space: nowrap;
      }

      .headline {
        margin-right: 200px;
      }

    </style>

    <div id="container" style$="[[_computeStyle(_settings.background, _settings.color, _settings.fontSize)]]">
      <div id="headlines">
        <dom-repeat items="[[data.items]]">
          <template>
            <span class="headline">[[item.text]]</span>
          </template>
        </dom-repeat>
      </div>
    </div>

  </template>

  <script>

  (() => {

    const DEFAULT_SETTINGS = {
      background: 'black',
      color: 'white',
      fontSize: 36,
      speed: 5
    };

    class AppNewsMarqueePlayer extends AppLocalizeMixin(Polymer.Element) {

      static get is() {return 'app-news-marquee-player';}

      static get config() {
        return {
          properties: {

            data: Object,

            _settings: {
              type: Object,
              value: DEFAULT_SETTINGS
            },

            _isAttached: {
              type: Boolean,
              value: false
            },

          },

          observers: [
            '_dataChanged(data, _isAttached)'
          ]
        };
      }

      constructor() {
        super();
        this._windowResized = this._windowResized.bind(this);
      }

      connectedCallback() {
        super.connectedCallback();
        requestAnimationFrame(_ => this._toggleListeners(true));
        this._isAttached = true;
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        requestAnimationFrame(_ => this._toggleListeners(false));
        this._isAttached = false;
      }

      _windowResized() {
        this._animate();
      }

      _dataChanged(data) {
        if (data) {
          this._updateSettings();
          this._animate();
        }
      }

      _toggleListeners(enable) {
        const m = enable ? 'addEventListener' : 'removeEventListener';
        window[m]('resize', this._windowResized);
      }

      _animate() {
        if (!this.data || !this.data.items) {
          return;
        }

        const rect = this.getBoundingClientRect();
        const durationFactor = Math.min(this.data.items.length * 3000, 16000);
        const duration = (10 - Number(this._settings.speed)) * durationFactor;

        if (this._animation) {
          this._animation.cancel();
        }

        requestAnimationFrame(_ => {
          this._animation = this.$.headlines.animate([
            {transform: `translateX(${rect.width}px)`},
            {transform: 'translateX(-100%)'}
          ], {
            duration,
            iterations: Infinity
          });
        });
      }

      _updateSettings() {
        if (this.data) {
          this._settings = Object.assign({}, DEFAULT_SETTINGS, this.data.settings);
        }
      }

      _computeStyle(background, color, fontSize) {
        return `background: ${background}; color: ${color}; font-size: ${fontSize}px;`;
      }

    }

    customElements.define(AppNewsMarqueePlayer.is, AppNewsMarqueePlayer);

  })();

  </script>
</dom-module>
