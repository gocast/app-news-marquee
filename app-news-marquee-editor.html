<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../dropdown-menu/dropdown-menu-container.html">
<link rel="import" href="../date-parser/date-parser.html">
<link rel="import" href="../goc-styles/goc-styles.html">
<link rel="import" href="../goc-icons/goc-icons.html">
<link rel="import" href="../touch-item/touch-item.html">
<link rel="import" href="app-news-marquee-publish-overlay.html">
<link rel="import" href="app-news-marquee-settings-overlay.html">

<!--
`app-news-marquee-editor`

@demo demo/app-news-marquee-editor.html 
-->

<dom-module id="app-news-marquee-editor">
  <template>
    <style include="header-layout-styles list-styles text-styles missing-well-styles">
      :host {
        background: var(--goc-background-color);
        display: block;
        height: 100%;
      }

      [hidden] {
        display: none !important;
      }

      .header-layout__content {
        padding: 20px 0;
      }

      .list__item {
        @apply(--layout-horizontal);
      }

      .news__text {
        word-break: break-all;
        margin-bottom: 4px;
      }

      .news__content {
        @apply(--layout-flex);
      }

    </style>

    <div class="header-layout">
      <div class="header-layout__header">
        <div class="header-toolbar">
          <a href="/">
            <paper-icon-button icon="arrow-back" aria-label="Go back"></paper-icon-button>
          </a>
          <div class="header-toolbar__main-content">
            <div class="header-toolbar__title">[[contentName]]</div>
            <div class="header-toolbar__subtitle">Marquesina de noticias</div>
          </div>
          <paper-spinner-lite class="header-toolbar__spinner" active="[[loading]]"></paper-spinner-lite>
          <paper-icon-button icon="message-plus" on-tap="_addTapped" aria-label="Add news item"></paper-icon-button>
          <paper-icon-button icon="brush" on-tap="_settingsTapped" aria-label="Add news item"></paper-icon-button>
        </div>
      </div>

      <div class="header-layout__content">
        <div class="list" hidden$="[[!data.items.length]]">
          <h3 class="list__title">Noticias publicadas</h3>

          <template id="domRepeat" is="dom-repeat" items="[[data.items]]">
            <touch-item on-tap="_itemTapped" class$="[[_computeItemClass(index)]]">
              <div class="news__content">
                <div class="news__text">[[item.text]]</div>
                <date-parser class="caption" date="[[item.date]]" format="time-ago"></date-parser>
              </div>

              <dropdown-menu-container item="[[item]]">
                <paper-icon-button icon="dots-vertical" title="More"></paper-icon-button>

                <template is="dom-template">
                  <button on-tap="_editTapped">Editar</button>
                  <button on-tap="_deleteTapped">Borrar</button>
                </template>
              </dropdown-menu-container>
            </touch-item>
          </template>
        </div>

        <template is="dom-if" if="[[!data.items.length]]">
          <div class="missing-well">
            <div class="missing-well__title">No hay noticias</div>
            <div class="missing-well__p">AÃ±ade noticias haciendo click en el icono de + de arriba a la derecha.</div>
          </div>
        </template>
      </div>
    </div>

  </template>
</dom-module>

<script>
(function() {
  'use strict';

  Polymer({

    is: 'app-news-marquee-editor',

    properties: {

      data: {
        type: Object,
        value: _ => {
          return {items: []};
        }
      },

      release: Object,

      contentId: Number,

      dataUpdatedAt: Number,

      releaseUpdatedAt: Number,

      contentName: String,

      loading: {
        type: Boolean,
        value: false
      }

    },

    _updateContent() {
      this.fire('content-update', {
        data: this.data,
        contentId: this.contentId,
        // directly to channel release
        updateRelease: true,
      });
    },

    _openPublishOverlay(item) {
      if (this._publishOverlay) {
        return;
      }

      this._publishOverlay = this.create('app-news-marquee-publish-overlay', {
        onDetach: _ => {
          this._publishOverlay = null;
        },
        text: item ? item.text : null,
        opened: true
      });

      this._publishOverlay.addEventListener('edit', event => {
        const index = this.data.items.indexOf(item);
        this.set(`data.items.${index}.text`, event.detail.text);
        this._updateContent();
        this._publishOverlay.opened = false;
      });

      this._publishOverlay.addEventListener('publish', event => {
        const item = {
          text: event.detail.text,
          date: new Date().getTime()
        };

        this.unshift('data.items', item);
        this._updateContent();
        this._publishOverlay.opened = false;
      });
    },

    _addTapped() {
      this._openPublishOverlay();
    },

    _itemTapped(event) {
      this._openPublishOverlay(event.model.item);
    },

    _editTapped(event) {
      const item = event.currentTarget.parentElement._dropdownContainer.item;
      this._openPublishOverlay(item);
    },

    _deleteTapped(event) {
      const item = event.currentTarget.parentElement._dropdownContainer.item;
      this.splice('data.items', this.data.items.indexOf(item), 1);
      this._updateContent();
    },

    _settingsTapped(event) {
      if (this._settingsOverlay) {
        return;
      }

      this._settingsOverlay = this.create('app-news-marquee-settings-overlay', {
        opened: true,
        onDetach: _ => {
          this._settingsOverlay = null;
        }
      });

      if (this.data.settings) {
        this._settingsOverlay.settings = this.data.settings;
      }

      this._settingsOverlay.addEventListener('save', event => {
        this.data.settings = event.detail.settings;
        this._updateContent();
        this._settingsOverlay.opened = false;
      });
    },

    _computeItemClass(index) {
      let classNames = 'list__item';

      if (index === this.data.items.length - 1) {
        classNames += ' list__item--last';
      }

      return classNames;
    }

  });

})();
</script>
